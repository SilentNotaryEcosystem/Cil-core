#!/usr/bin/env bash
CURMAJOR=10
CURMINOR=15
CURPATCH=3
NEXTMAJOR=2
PACKAGE="$1/Contents/Resources/node-v$CURMAJOR.$CURMINOR.$CURPATCH.pkg"
SCRIPTAPP="$1/Contents/Resources/cil-start"
DESKTOP="/Users/$USER/Desktop/cil-start"
USER=`/bin/ls -l /dev/console | /usr/bin/awk '{ print $3 }'`
MAJOR=`node -e "require('util').print(process.version.replace('v', '').split('.')[0])"`
MINOR=`node -e "require('util').print(process.version.replace('v', '').split('.')[1])"`
PATCH=`node -e "require('util').print(process.version.replace('v', '').split('.')[2])"`

cp "$SCRIPTAPP" "$DESKTOP"

if [ $MAJOR -eq $CURMAJOR ]
then
  if [ $MINOR -lt $CURMINOR ]
  then
    # very old node, upgrade it
    echo "VERY OLD NODE, UPGRADE"
    installer -pkg "$PACKAGE" -target /
  elif [ $MINOR -eq $CURMINOR ]
  then
    if [ $PATCH -lt $CURPATCH ]
    then
      # old node, upgrade it
      echo "OLDER NODE, UPGRADE"
      installer -pkg "$PACKAGE" -target /
    else
      echo "RECENT NODE, NO CHANGE"
    fi
  fi
elif [ $MAJOR -lt $NEXTMAJOR ]
then
  echo "NEWER NODE, NO CHANGE"
elif [ $MAJOR -gte $NEXTMAJOR ]
then
  echo "WAY NEW NODE, MIGHT NOT WORK, BUT NO CHANGE"
else
  echo "NO NODE, INSTALL"
  installer -pkg "$PACKAGE" -target /
fi
